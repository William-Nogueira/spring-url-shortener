<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Analytics - ShortLink</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); }
        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen p-6">

<div class="max-w-4xl mx-auto animate-slide-up">

    <div class="mb-8 flex items-center justify-between">
        <a href="/" class="flex items-center text-gray-400 hover:text-white transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
            Back to Shortener
        </a>
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
            Analytics
        </h1>
    </div>

    <div id="loading" class="text-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-400 mx-auto mb-4"></div>
        <p class="text-gray-500">Fetching data...</p>
    </div>

    <div id="error" class="hidden text-center py-20">
        <p class="text-red-400 text-xl font-bold">Link not found</p>
        <p class="text-gray-500 mt-2">The requested analytics data is unavailable.</p>
    </div>

    <div id="dashboard" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">

        <div class="md:col-span-2 glass border border-gray-700 rounded-2xl p-6 shadow-xl">
            <h2 class="text-gray-400 text-sm uppercase tracking-wide font-semibold mb-4">Target URL</h2>
            <a id="originalLink" href="#" target="_blank" class="text-xl text-blue-400 hover:underline break-all block mb-6">
            </a>

            <div class="border-t border-gray-700 pt-6">
                <h2 class="text-gray-400 text-sm uppercase tracking-wide font-semibold mb-2">Short Link</h2>
                <div class="flex items-center bg-gray-800 rounded-lg p-3 border border-gray-600">
                    <span id="shortLinkDisplay" class="text-emerald-400 font-mono flex-1 truncate"></span>

                    <span id="copyFeedback" class="hidden text-xs text-emerald-400 font-bold ml-2 mr-2 animate-bounce flex-shrink-0">Copied!</span>

                    <button id="copyBtn" class="text-gray-400 hover:text-white transition p-1 rounded hover:bg-gray-700" title="Copy to clipboard">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </button>

                </div>
            </div>
        </div>

        <div class="glass border border-gray-700 rounded-2xl p-6 shadow-xl flex flex-col items-center justify-center">
            <h2 class="text-gray-400 text-sm uppercase tracking-wide font-semibold mb-4">QR Code</h2>
            <div class="bg-white p-2 rounded-lg">
                <img id="qrImage" src="" alt="QR Code" class="w-32 h-32 object-contain">
            </div>
        </div>

        <div class="glass border border-gray-700 rounded-2xl p-6 shadow-xl relative group">

            <button id="refreshBtn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition p-2 rounded-full hover:bg-gray-700/50" title="Refresh Data">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>

            <div class="flex items-center">
                <div class="p-3 bg-blue-900/50 rounded-full mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                </div>

                <div>
                    <h3 class="text-gray-400 text-xs uppercase font-bold">Total Clicks</h3>
                    <span id="clickCount" class="text-4xl font-bold text-white transition-all duration-300">0</span>
                </div>
            </div>
        </div>

        <div class="md:col-span-2 glass border border-gray-700 rounded-2xl p-6 shadow-xl">
            <div class="flex items-center">
                <div class="p-3 bg-emerald-900/50 rounded-full mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-gray-400 text-xs uppercase font-bold">Created At</h3>
                    <p id="createdDate" class="text-lg text-white font-medium">--</p>
                    <p id="timeAgo" class="text-sm text-gray-500">--</p>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    const pathSegments = globalThis.location.pathname.split('/');
    const code = pathSegments.findLast(segment => segment.length > 0);

    const originalLink = document.getElementById('originalLink');
    const shortLinkDisplay = document.getElementById('shortLinkDisplay');
    const clickCount = document.getElementById('clickCount');
    const createdDate = document.getElementById('createdDate');
    const timeAgoEl = document.getElementById('timeAgo');
    const qrImage = document.getElementById('qrImage');

    const loading = document.getElementById('loading');
    const dashboard = document.getElementById('dashboard');
    const errorDiv = document.getElementById('error');
    const refreshBtn = document.getElementById('refreshBtn');

    const timeAgo = (date) => {
        const seconds = Math.floor((Date.now() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " years ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " months ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " days ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " hours ago";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " minutes ago";
        return "Just now";
    };

    const setupCopyButton = () => {
        const copyBtn = document.getElementById('copyBtn');
        const feedback = document.getElementById('copyFeedback');

        if (copyBtn && feedback) {
            const newBtn = copyBtn.cloneNode(true);
            copyBtn.parentNode.replaceChild(newBtn, copyBtn);

            newBtn.addEventListener('click', () => {
                const text = shortLinkDisplay.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    feedback.classList.remove('hidden');
                    setTimeout(() => {
                        feedback.classList.add('hidden');
                    }, 2000);
                }).catch(err => console.error("Copy failed", err));
            });
        }
    };

    async function loadData(isRefresh = false) {
        try {
            if (isRefresh) {
                const icon = refreshBtn.querySelector('svg');
                if(icon) icon.classList.add('animate-spin');
                refreshBtn.disabled = true;
            }

            const res = await fetch(`/api/data/${code}`);
            if (!res.ok) throw new Error('Not found');

            const data = await res.json();

            originalLink.href = data.originalUrl;
            originalLink.textContent = data.originalUrl;
            shortLinkDisplay.textContent = data.shortUrl;
            clickCount.textContent = data.clicks;

            const date = new Date(data.createdAt);
            createdDate.textContent = date.toLocaleString(undefined, {
                year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            timeAgoEl.textContent = timeAgo(date);

            if (!isRefresh) {
                qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(data.shortUrl)}`;
                setupCopyButton();
                loading.classList.add('hidden');
                dashboard.classList.remove('hidden');
            }
        } catch (err) {
            if (!isRefresh) {
                loading.classList.add('hidden');
                errorDiv.classList.remove('hidden');
            }
            console.error(err);
        } finally {
            if (isRefresh) {
                setTimeout(() => {
                    const icon = refreshBtn.querySelector('svg');
                    if(icon) icon.classList.remove('animate-spin');
                    refreshBtn.disabled = false;
                }, 500);
            }
        }
    }

    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => loadData(true));
    }

    await loadData(false);

</script>
</body>
</html>